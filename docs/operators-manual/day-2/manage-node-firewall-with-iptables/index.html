<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<title data-react-helmet="true">Manage Node Firewall Using iptables | Openmetal Docs</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://openmetalio.github.io/openmetal-docs/docs/operators-manual/day-2/manage-node-firewall-with-iptables"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Manage Node Firewall Using iptables | Openmetal Docs"><meta data-react-helmet="true" name="description" content="- [Manage Node Firewall Using"><meta data-react-helmet="true" property="og:description" content="- [Manage Node Firewall Using"><link data-react-helmet="true" rel="icon" href="/openmetal-docs/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://openmetalio.github.io/openmetal-docs/docs/operators-manual/day-2/manage-node-firewall-with-iptables"><link data-react-helmet="true" rel="alternate" href="https://openmetalio.github.io/openmetal-docs/docs/operators-manual/day-2/manage-node-firewall-with-iptables" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://openmetalio.github.io/openmetal-docs/docs/operators-manual/day-2/manage-node-firewall-with-iptables" hreflang="x-default"><link rel="stylesheet" href="/openmetal-docs/assets/css/styles.0b4a7092.css">
<link rel="preload" href="/openmetal-docs/assets/js/runtime~main.a78bd390.js" as="script">
<link rel="preload" href="/openmetal-docs/assets/js/main.32bb5b19.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/openmetal-docs/"><div class="navbar__logo"><img src="/openmetal-docs/img/openmetal.svg" alt="Openmetal" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/openmetal-docs/img/openmetal.svg" alt="Openmetal" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title"></b></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/openmetalio/openmetal-docs" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_TwRn" href="/openmetal-docs/docs/users_manual/">User&#x27;s Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;User&#x27;s Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--active hasHref_TwRn" href="/openmetal-docs/docs/operators-manual/">Operator&#x27;s Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Operator&#x27;s Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-1/command-line/create-ssh-key">Day 1</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active hasHref_TwRn" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-2/resource-usage/cloud-resource-usage">Day 2</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-2/resource-usage/cloud-resource-usage">Resource Usage</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-2/check-ceph-status-disk-usage">How to Check Ceph&#x27;s Status and Disk Usage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-2/introduction-to-ceph">Introduction to Ceph</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-2/live-migrate-instances">How to Live Migrate Instances Using OpenStack Horizon</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-2/maintenance">Maintaining OpenStack Software Updates</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-2/manage-node-firewall-with-iptables">Manage Node Firewall Using iptables</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-2/private-cloud-deployment-overview">How Private Clouds are Deployed</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-3/add-provider-ips">Day 3</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" tabindex="0" href="/openmetal-docs/docs/operators-manual/day-4/automation/heat">Day 4</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link hasHref_TwRn" href="/openmetal-docs/docs/operators-manual-extras/">Operator&#x27;s Manual Extras</a><button aria-label="Toggle the collapsible sidebar category &#x27;Operator&#x27;s Manual Extras&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist hasHref_TwRn" href="/openmetal-docs/docs/how-to-guides/horizon/live-migrate-instance">How to Guides</a></div></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Manage Node Firewall Using iptables</h1></header><ul><li><a href="#manage-node-firewall-using-iptables">Manage Node Firewall Using
iptables</a><ul><li><a href="#use-case">Use Case</a></li><li><a href="#goal">Goal</a></li><li><a href="#prerequisites">Prerequisites</a><ul><li><a href="#identify-active-firewall-driver">Identify Active Firewall
Driver</a></li><li><a href="#reconfigure-firewall-driver-with-kolla-ansible">Reconfigure Firewall Driver with Kolla
Ansible</a></li></ul></li><li><a href="#install-and-configure-firewall">Install and Configure
Firewall</a><ul><li><a href="#install-ipset-and-iptables">Install ipset and iptables</a></li><li><a href="#configure-services">Configure Services</a></li></ul></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="use-case">Use Case<a class="hash-link" href="#use-case" title="Direct link to heading">​</a></h2><p>In cases where access restriction and attack surface reduction is key,
your project landscape may require assets and management be accessible
only to select IPs or networks (such as a company VPN). Such a
restriction can be handled on the Hardware Node level, allowing access
to be easily managed separately without interference from or with Docker
or OpenStack internal communication.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="goal">Goal<a class="hash-link" href="#goal" title="Direct link to heading">​</a></h2><p>Use <code>iptables</code> and <code>ipset</code> to restrict access to local (eg. ssh) and/or
Cloud services (HAProxy) on an OpenStack node without interfering with
Docker.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="prerequisites">Prerequisites<a class="hash-link" href="#prerequisites" title="Direct link to heading">​</a></h2><ul><li>Root SSH access to node</li><li>Knowledge of OS package management</li><li>OpenVSwitch Firewall Driver</li><li>Kolla Ansible (if driver reconfigure required)</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="identify-active-firewall-driver">Identify Active Firewall Driver<a class="hash-link" href="#identify-active-firewall-driver" title="Direct link to heading">​</a></h3><p>You will first need to identify the driver actively in use by Neutron
port security. This is defined in <code>openvswitch_agent.ini</code>. This can be
confirmed using the <code>grep</code> command.</p><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]# grep firewall_driver /etc/kolla/neutron-openvswitch-agent/openvswitch_agent.ini</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall_driver = neutron.agent.linux.iptables_firewall.OVSHybridIptablesFirewallDriver</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>If the <code>firewall_driver</code> is defined as <code>openvswitch</code> proceed to
<a href="#setup">Setup</a>.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="reconfigure-firewall-driver-with-kolla-ansible">Reconfigure Firewall Driver with Kolla Ansible<a class="hash-link" href="#reconfigure-firewall-driver-with-kolla-ansible" title="Direct link to heading">​</a></h3><p>If the default Hybrid driver is in use you will need to update the
<a href="/openmetal-docs/docs/operators-manual/day-2/operators_manual/day-4/kolla-ansible/kolla-ansible.rst">Kolla Ansible</a>
configuration at <code>/etc/kolla/config/neutron/openvswitch_agent.ini</code>.</p><p>If the <code>openvswitch_agent.ini</code> file does not exist, create it with the
following contents:</p><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain"># Ensures firewall rules are fully-managed in OVS instead of using</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># host iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[securitygroup]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall_driver = openvswitch</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]# cat /etc/kolla/config/neutron/openvswitch_agent.ini</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Ensures firewall rules are fully-managed in OVS instead of using</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># host iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[securitygroup]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall_driver = openvswitch</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Once in place, reconfigure the cloud with <code>kolla-ansible reconfigure</code>
you can target just the changed services with <code>--tags
neutron,openvswitch</code>:</p><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">(.kolla-admin) [root@exhilarated-firefly kolla-ansible]# kolla-ansible -i /etc/fm-deploy/kolla-ansible-inventory reconfigure --tags neutron,openvswitch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Reconfigure OpenStack service : ansible-playbook -i /etc/fm-deploy/kolla-ansible-inventory -e @/etc/kolla/globals.yml  -e @/etc/kolla/passwords.yml -e CONFIG_DIR=/etc/kolla  --tags neutron,openvswitch -e kolla_action=reconfigure -e kolla_serial=0 /opt/kolla-ansible/.kolla-admin/share/kolla-ansible/ansible/site.yml </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[WARNING]: Invalid characters were found in group names but not replaced, use -vvvv to see details</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[WARNING]: Could not match supplied host pattern, ignoring: enable_nova_True</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--- OUTPUT TRUNCATED ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PLAY RECAP *********************************************************************************************************************************************************************************************************</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">exhilarated-firefly        : ok=33   changed=5    unreachable=0    failed=0    skipped=18   rescued=0    ignored=0   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">gifted-wildcat             : ok=43   changed=6    unreachable=0    failed=0    skipped=19   rescued=0    ignored=0   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">localhost                  : ok=4    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">upbeat-peacock             : ok=33   changed=5    unreachable=0    failed=0    skipped=18   rescued=0    ignored=0</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Confirm your change is now reflected:</p><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly kolla-ansible]# grep firewall_driver /etc/kolla/neutron-openvswitch-agent/openvswitch_agent.ini</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">firewall_driver = openvswitch</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>Proceed to <a href="#install-and-configure-firewall">installation</a>.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="install-and-configure-firewall">Install and Configure Firewall<a class="hash-link" href="#install-and-configure-firewall" title="Direct link to heading">​</a></h2><blockquote><ul><li><strong>CAUTION<!-- -->!</strong> This process can potentially result in loss of
access to your cloud. Perform these steps on one node at a time to
limit the possibility of total loss of access.</li></ul></blockquote><h3 class="anchor anchorWithStickyNavbar_y2LR" id="install-ipset-and-iptables">Install ipset and iptables<a class="hash-link" href="#install-ipset-and-iptables" title="Direct link to heading">​</a></h3><ol><li>Begin by installing the required packages with <code>yum</code>:</li></ol><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">yum install iptables-services ipset ipset-service -y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- OUTPUT TRUNCATED ---</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Installed:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ipset-7.1-1.el8.x86_64         ipset-libs-7.1-1.el8.x86_64           ipset-service-7.1-1.el8.noarch           iptables-services-1.8.4-17.el8_4.1.x86_64                     </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Complete!</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="configure-services">Configure Services<a class="hash-link" href="#configure-services" title="Direct link to heading">​</a></h3><ol><li>Identify the nodes vlan bond devices with <code>ip</code>:</li></ol><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]# ip -br a | awk -F&#x27;@bond0&#x27; &#x27;/bond0\./{print$1}&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bond0.393</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bond0.392</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bond0.396</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bond0.394</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bond0.395</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">bond0.8</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol><li><p>Create a new iptables configuration at <code>/etc/sysconfig/iptables</code>.</p><blockquote><p><strong>NOTE<!-- -->!</strong>: To ensure all VLAN traffic is accepted, special
attention must be paid to the <code>ACCEPT</code> rules (eg. <code>bond0.304</code>
etc). <strong>Be sure to update the Local VLAN rules with the nodes
identified interface names</strong></p></blockquote><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">*filter</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:INPUT ACCEPT [0:0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:FORWARD ACCEPT [0:0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">:OUTPUT ACCEPT [0:0]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -i lo -j ACCEPT -m comment --comment &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A OUTPUT -o lo -j ACCEPT -m comment --comment &quot;localhost&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT  -j ACCEPT -m pkttype --pkt-type multicast -m comment --comment &quot;multicast&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A OUTPUT -j ACCEPT -m pkttype --pkt-type multicast -m comment --comment &quot;multicast&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -j ACCEPT -m pkttype --pkt-type broadcast -m comment --comment &quot;broadcast&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A OUTPUT -j ACCEPT -m pkttype --pkt-type broadcast -m comment --comment &quot;broadcast&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT  -j DROP -m set --match-set blacklist src -m comment --comment &quot;blacklist&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A OUTPUT -j DROP -m set --match-set blacklist dst -m comment --comment &quot;blacklist&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -p icmp -j ACCEPT -m comment --comment &quot;allow icmp&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT  -m state --state RELATED,ESTABLISHED -j ACCEPT -m comment --comment &quot;connection tracking&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -i bond0.304 -j ACCEPT -m comment --comment &quot;Local VLAN - compute&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -i bond0.306 -j ACCEPT -m comment --comment &quot;Local VLAN - control&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -i bond0.332 -j ACCEPT -m comment --comment &quot;Local VLAN - storage&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -i bond0.333 -j ACCEPT -m comment --comment &quot;Local VLAN - tunnel&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -i o-hm0 -j ACCEPT -m comment --comment &quot;Octavia management&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -p vrrp -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -p tcp -s 10.204.0.1 -m comment --comment &quot;OMI Pod VLAN 8 management&quot; -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -p udp -s 10.204.0.1 -m comment --comment &quot;OMI Pod VLAN 8 management&quot; -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -p tcp -s 173.231.217.0/28 -m comment --comment &quot;OMI Pod Management and Support&quot; -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT  -j ACCEPT -m set --match-set whitelist src -m comment --comment &quot;whitelist&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -p tcp -m tcp --dport 22 -m state --state NEW -m comment --comment &quot;ssh&quot; -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -p tcp -m tcp --dport 80 -m state --state NEW -m comment --comment &quot;http/haproxy&quot; -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -p tcp -m tcp --dport 443 -m state --state NEW -m comment --comment &quot;https/haproxy&quot; -j ACCEPT</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-A INPUT -j DROP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">COMMIT</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li></ol><ol><li><p>Create a new ipset configuration at <code>/etc/sysconfig/ipset</code></p><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">###</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ipset IP lists</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># To reload: systemctl restart ipset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">##</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">create whitelist hash:net family inet hashsize 1024 maxelem 65536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">create blacklist hash:net family inet hashsize 1024 maxelem 65536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">create multicast hash:net family inet hashsize 1024 maxelem 65536</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Multicast/Broadcast IPs required for VRRP, DHCP, other protocols</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add multicast 224.0.0.0/4</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add multicast 255.255.255.255</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">## Whitelisted IPs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># OMI VPN IP (support)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">add whitelist 173.231.218.25</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Add your additional IPs here...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#add whitelist W.X.Y.Z</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>The services now need to be restarted for the changes to take
effect. Do <strong>NOT</strong> enable auto-start yet, in case something goes
wrong.</p><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]# systemctl restart ipset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]# systemctl restart iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>Confirm that the firewall is working as expected. This can be done
by attempting to access services (ssh etc) from both a whitelisted
IP and an undefined network.</p></li><li><p>Once confirmed, enable auto-start for both services.</p><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]# systemctl enable ipset</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created symlink /etc/systemd/system/basic.target.wants/ipset.service → /usr/lib/systemd/system/ipset.service.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]# systemctl enable iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Created symlink /etc/systemd/system/multi-user.target.wants/iptables.service → /usr/lib/systemd/system/iptables.service.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>Copy the newly created files to the root users home folder accross
the rest of the nodes.</p><div class="codeBlockContainer_J+bg language-sourceCode theme-code-block"><div class="codeBlockContent_csEI sourceCode"><pre tabindex="0" class="prism-code language-sourceCode codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]# for node in $(awk &#x27;!/localhost/&amp;&amp;/local/{print$NF}&#x27; /etc/hosts| grep -v $(hostname -s)); do echo &quot;scp -i .ssh/fm-deploy /etc/sysconfig/ipset $node:~/new-ipset &amp;&amp; scp -i .ssh/fm-deploy /etc/sysconfig/iptables $node:~/new-iptables&quot;; done</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp -i .ssh/fm-deploy /etc/sysconfig/ipset gifted-wildcat:~/new-ipset &amp;&amp; scp -i .ssh/fm-deploy /etc/sysconfig/iptables gifted-wildcat:~/new-iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">scp -i .ssh/fm-deploy /etc/sysconfig/ipset upbeat-peacock:~/new-ipset &amp;&amp; scp -i .ssh/fm-deploy /etc/sysconfig/iptables upbeat-peacock:~/new-iptables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[root@exhilarated-firefly ~]#</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div></li><li><p>Deploy to the remaining nodes.</p></li></ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/openmetalio/openmetal-docs/blob/main/docs/operators-manual/day-2/manage-node-firewall-with-iptables.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/openmetal-docs/docs/operators-manual/day-2/maintenance"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Maintaining OpenStack Software Updates</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/openmetal-docs/docs/operators-manual/day-2/private-cloud-deployment-overview"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">How Private Clouds are Deployed</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#use-case" class="table-of-contents__link toc-highlight">Use Case</a></li><li><a href="#goal" class="table-of-contents__link toc-highlight">Goal</a></li><li><a href="#prerequisites" class="table-of-contents__link toc-highlight">Prerequisites</a><ul><li><a href="#identify-active-firewall-driver" class="table-of-contents__link toc-highlight">Identify Active Firewall Driver</a></li><li><a href="#reconfigure-firewall-driver-with-kolla-ansible" class="table-of-contents__link toc-highlight">Reconfigure Firewall Driver with Kolla Ansible</a></li></ul></li><li><a href="#install-and-configure-firewall" class="table-of-contents__link toc-highlight">Install and Configure Firewall</a><ul><li><a href="#install-ipset-and-iptables" class="table-of-contents__link toc-highlight">Install ipset and iptables</a></li><li><a href="#configure-services" class="table-of-contents__link toc-highlight">Configure Services</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/openmetal-docs/img/openmetal.svg" alt="Facebook Open Source Logo" class="themedImage_TMUO themedImage--light_4Vu1 footer__logo"><img src="/openmetal-docs/img/openmetal.svg" alt="Facebook Open Source Logo" class="themedImage_TMUO themedImage--dark_uzRr footer__logo"></div><div class="footer__copyright"><strong>2022 © OpenMetal, a division of <a href="https://www.inmotionhosting.com" target="_blank" rel="noopener">InMotion Hosting</a>.  All rights reserved.</strong></div></div><div class="footerContact_lPaK"><p>555 S. Independence Blvd, Virginia Beach, VA 23452</p><div class="contactLinks_EKti"><a href="tel:+18777289664">877-7-BUY-OMI</a><a href="mailto:sales@openmetal.io">sales@openmetal.io</a><a href="https://openmetal.io/schedule-meeting/">Schedule a Demo</a></div><p><strong>OpenMetal Central:</strong> <a target="_blank" href="https://central.openmetal.io/auth/sign-in">Login</a> or <a target="_blank" href="https://central.openmetal.io/sign-up">Create New Account</a></p></div></div></footer></div>
<script src="/openmetal-docs/assets/js/runtime~main.a78bd390.js"></script>
<script src="/openmetal-docs/assets/js/main.32bb5b19.js"></script>
</body>
</html>